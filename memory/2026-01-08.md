
## Lesson Learned: Cron Jobs

**Use `isolated` + `agentTurn` for crons that must execute:**

```json
{
  "sessionTarget": "isolated",
  "payload": {
    "kind": "agentTurn",
    "message": "Run: python3 script.py\n\nIf results, notify David. Otherwise stay silent.",
    "deliver": true
  }
}
```

‚ùå `systemEvent` to `main` session ‚Äî may be ignored during heartbeat cycles
‚úÖ `agentTurn` to `isolated` session ‚Äî spawns separate agent that executes

## Day Summary

**Cron fixes:**
- Changed all crons to use `sessionTarget: "isolated"` + `payload.kind: "agentTurn"`
- Added explicit "reply HEARTBEAT_OK" instructions to suppress empty notifications
- Tightened prompts with "No preamble, no confirmation, no extra text"

**MS Teams PR:**
- Merged PR #404 from upstream (4,656 lines by @onutc)
- Build has type warnings but compiles and runs
- Awaiting Azure Bot setup (David waiting on credit card from controller)

**Skills published to ClawdHub:**
- `github-pr` v1.0.0 - Fetch, preview, merge PRs from upstream
- `process-watch` v1.0.0 - System monitoring (CPU, mem, ports, processes)

**Still missing credentials (15 skills):**
vercel, godaddy, cloudflare, tmdb, sag, homeassistant, bird, notion, reddit, trello, gifgrep, eightctl, openhue, things-mac, ordercli

**Tomorrow:**
- Kate's flight reminder at 1:30 PM (PVD‚ÜíORF, 5pm Breeze)

## EMMA Research - The Baldwin at Woodmont Commons

**Issue:** Business Finance Authority of NH Revenue Bonds (The Baldwin at Woodmont Commons Project) Series 2022
**EMMA URL:** https://emma.msrb.org/IssueView/Details/P2415140
**Total Bonds:** $188.7M
**Project:** CCRC with 190 IL + 40 AL/MC = 230 units

### Documents Retrieved
- Official Statement (2022) - 4.3MB, 292 pages ‚úÖ Text extractable
- Q3 2025 Quarterly - 2MB, 6 pages ‚ö†Ô∏è Image-based (needs OCR)
- Occupancy Report (Dec 2025) - 49KB ‚úÖ Text extractable

### Key Findings

**Occupancy (Dec 19, 2025 vs. Dec 2025 Projections):**
- IL: 188/190 (98.95%) vs. projected 163 (85.5%) ‚Üí **+13.45% ahead**
- AL/MC: 23/40 (57.5%) vs. projected 26 (66%) ‚Üí **-8.5% behind**

**Covenants:**
- DSCR: ‚â• 1.20 (Event of Default if <1.00 or misses 3x)
- Days Cash: ‚â• 90 (with Support) / ‚â• 100 (without)
- Testing: June 30 & Dec 31 each year

### Dashboard Coverage from EMMA

**‚úÖ Available:**
- Census by level of care (weekly occupancy reports)
- Cash on hand (quarterly financials)
- NOI (quarterly financials)
- Covenant compliance (quarterly reports)
- Waitlist/presale data (monthly presale reports)
- CapEx updates (event notices)

**‚ö†Ô∏è Requires OCR:**
- Q3 2025 quarterly (image-based PDF)
- Some older reports may be scanned

**‚ùå Not from EMMA - Other Sources Needed:**
- Star ratings, deficiencies ‚Üí CMS Care Compare API
- Infection rates, falls, pressure ulcers ‚Üí CMS/internal
- Staffing levels, turnover, agency ‚Üí Internal data
- Days in AR ‚Üí Internal accounting
- Workman's comp, legal ‚Üí Internal
- Private pay rates (competitors) ‚Üí Market research
- Wage trends ‚Üí BLS/market data
- Housing market ‚Üí Zillow/Redfin API
- Hospital bed availability ‚Üí State health dept

### EMMA Access Notes
- Direct curl blocked (403 Forbidden)
- Must use browser session with cookies
- Key cookie: `Disclaimer6=msrborg` (Terms acceptance)
- PDFs via browser print-to-PDF lose text; use curl with session cookies

## EMMA Skill Created

**Location:** `skills/emma/`

**Commands:**
```bash
cd skills/emma
uv run python scripts/emma.py issue P2415140          # Get issue info
uv run python scripts/emma.py docs P2415140           # List documents
uv run python scripts/emma.py download P2415140 -o ./docs/  # Download PDFs
uv run python scripts/emma.py extract P2415140 --from-dir ./docs/  # Extract metrics
```

**Extracts:**
- Unit counts (IL, AL/MC) from Official Statement
- Covenant requirements (DSCR, Days Cash)
- Current occupancy from latest occupancy report

**Limitations:**
- Doc descriptions generic (EMMA uses JS rendering)
- Some PDFs image-based (need OCR for quarterly financials)
- Text extraction regex-based (works for standard formats)

**Next steps for production:**
- Add `sync` command to push to Twenty CRM + SharePoint
- Consider browser automation for richer metadata
- OCR integration for image-based PDFs (when needed)

## EMMA Skill - Final Status

**Twenty CRM IDs for Baldwin:**
- `ec3a2ef6-7ecf-4735-8053-ba8681f9cbd9` - Edgewood - Baldwin (main)
- `a299d910-1dc7-4285-9829-6e506088a313` - Baldwin (Edgewood) - expansion

**SharePoint:**
- Auth: ‚úÖ Working
- Search: ‚úÖ Working  
- "Edgewood - Baldwin" folder exists with existing docs
- Upload: Ready (needs drive ID for specific site)

**Full workflow working:**
```bash
cd skills/emma
uv run python scripts/emma.py sync P2415140 \
  --twenty-id "ec3a2ef6-7ecf-4735-8053-ba8681f9cbd9" \
  --from-dir /Users/dbhurley/clawd/emma-docs/baldwin
```

**Credentials (in clawdbot.json):**
- TWENTY_API_TOKEN ‚úÖ
- TWENTY_API_URL: https://api.mollified.app
- SHAREPOINT_TENANT_ID ‚úÖ
- SHAREPOINT_CLIENT_ID ‚úÖ
- SHAREPOINT_CLIENT_SECRET ‚úÖ

## EMMA Skill Complete! üéâ

Full workflow working:
- `emma.py auto <url> --name "Name" --sharepoint-drive <id> --sharepoint-folder <path>`

What it does:
1. Downloads EMMA documents
2. Extracts metrics (units, covenants, occupancy)
3. Creates note on Twenty engagement
4. Uploads PDFs to SharePoint

SharePoint permissions fixed - `Files.ReadWrite.All` now granted.

Edgewood drive ID: `b!BSgduoDHskSBWcXef_RHjCAe8KYwVl1Alb9bkeMNAeVXqSdvhITOSq_Cl0M2iPpR`
