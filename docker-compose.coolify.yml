services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile

    environment:
      # Required settings
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
      - ZAI_API_KEY=${ZAI_API_KEY:-PLACEHOLDER_KEY}

      # Optional with defaults
      - OPENCLAW_GATEWAY_PORT=${OPENCLAW_GATEWAY_PORT:-28471}
      - OPENCLAW_GATEWAY_BIND=${OPENCLAW_GATEWAY_BIND:-lan}
      - NODE_ENV=production
      - HOME=/root
      - TERM=xterm-256color
      - OPENCLAW_STATE_DIR=/root/.openclaw
      - OPENCLAW_WORKSPACE=/root/openclaw-workspace

    volumes:
      - openclaw-config:/root/.openclaw
      - openclaw-workspace:/root/openclaw-workspace

    # NOTE: Running as root due to Coolify volume permission behavior.
    # Coolify creates volumes as root, causing EACCES for non-root users.
    # See: https://github.com/coollabsio/coolify/issues/2873
    # Security trade-off accepted for compatibility.
    user: "0"

    # Security hardening (limited by root requirement)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Healthcheck using HTTP (more accurate than TCP)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${OPENCLAW_GATEWAY_PORT:-28471}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resources (8GB RAM / 2 vCPU)
    deploy:
      resources:
        limits:
          memory: 6G
          cpus: '1.8'
        reservations:
          memory: 2G
          cpus: '0.5'
      restart_policy:
        condition: unless-stopped
        delay: 5s

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

    # Network
    expose:
      - "${OPENCLAW_GATEWAY_PORT:-28471}"

    init: true
    stop_grace_period: 30s

    # Use external bootstrap script for easier maintenance
    command: ["bash", "/app/scripts/coolify-bootstrap.sh"]

volumes:
  openclaw-config:
  openclaw-workspace:
